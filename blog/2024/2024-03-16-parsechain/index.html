<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <div align="center"> # ü™¢ GrammarFlow üöÄ Powering Agent Chains by Constraining LLM Outputs üöÄ </div> <h1 id="table-of-contents">Table of contents</h1> <ol> <li><a href="https://github.com/e-lab/SyntaxShaper/tree/main?tab=readme-ov-file#-what-is-this" rel="external nofollow noopener" target="_blank">What is this</a></li> <li><a href="https://github.com/e-lab/SyntaxShaper/tree/main?tab=readme-ov-file#-quick-install" rel="external nofollow noopener" target="_blank">Quick Install</a></li> <li><a href="https://github.com/e-lab/SyntaxShaper/tree/main?tab=readme-ov-file#-code-usage" rel="external nofollow noopener" target="_blank">Code Usage</a></li> <li><a href="https://github.com/e-lab/SyntaxShaper/tree/main?tab=readme-ov-file#examples--samples" rel="external nofollow noopener" target="_blank">Examples (@ samples/)</a></li> <li><a href="https://github.com/e-lab/SyntaxShaper/tree/main?tab=readme-ov-file#gnbf-grammar" rel="external nofollow noopener" target="_blank">GNBF Grammar</a></li> <li><a href="https://github.com/e-lab/SyntaxShaper/tree/main?tab=readme-ov-file#remarks" rel="external nofollow noopener" target="_blank">Remarks!</a></li> <li><a href="https://github.com/e-lab/SyntaxShaper/tree/main?tab=readme-ov-file#citation" rel="external nofollow noopener" target="_blank">Citation</a></li> </ol> <h2 id="-what-is-this">ü§î What is this?</h2> <p>This repository contains code to abstract the LLM output constraining process. It helps you define your grammar rules using Pydantic and Typing in a pythonic way, and inherently embeds metadata from these dataclasses into the prompt. Parsing is enabled in JSON, TOML and XML formats, with custom parsers that avoid the issues faced by <code class="language-plaintext highlighter-rouge">json.loads</code> (..etc) while parsing direct outputs. It can also create GNBF grammr from the same, which is used by the <code class="language-plaintext highlighter-rouge">llama.cpp</code> package for sampling logits smartly.</p> <p>The goal of this package was to overcome the issues faced when using langchain‚Äôs output parsers with instruct language models. While GPT-4 produces consistent results in returning the correct formats, Llama-7B would cause parsing errors in my testing chains with more complex prompts.</p> <blockquote> <p>Please reach out to <code class="language-plaintext highlighter-rouge">araviki [at] purdue [dot] edu</code> or open an issue on Github if you have any questions or inquiry related to GrammarFlow and its usage.</p> </blockquote> <h2 id="-quick-install">‚ö° Quick Install</h2> <p><code class="language-plaintext highlighter-rouge">pip install grammarflow</code></p> <h2 id="-code-usage">üìÉ Code Usage</h2> <ol> <li>Map out what your agent chain is doing. Understand what it‚Äôs goals are and what data needs to be carried forward from one step to the next. For example, consider the <a href="https://react-lm.github.io/" rel="external nofollow noopener" target="_blank">ReAct prompting framework</a>. In every call, we want to pass in the Action and subsequent Observation to the next call.</li> </ol> <p>1.1. Load grammarflow</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from grammarflow import * 
</code></pre></div></div> <ol> <li>Make a Pydantic Model for the above case. Here‚Äôs a sample: <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ThoughtState</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
 <span class="n">thought</span><span class="p">:</span> <span class="nb">str</span>
 <span class="n">goal</span><span class="p">:</span> <span class="nb">str</span>
 <span class="n">tool</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span>
                   <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Choose one of [</span><span class="sh">'</span><span class="s">Web_QA</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Web_Search</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Web_Scraping</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Web_Automation</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Web_Research</span><span class="sh">'</span><span class="s">]</span><span class="sh">"</span><span class="p">)</span>
 <span class="n">action</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span>
                     <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Choose one of [</span><span class="sh">'</span><span class="s">Create</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Update</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Delete</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Read</span><span class="sh">'</span><span class="s">]</span><span class="sh">"</span><span class="p">)</span>
 <span class="n">action_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">The input data for the action</span><span class="sh">"</span><span class="p">)</span>
 <span class="n">thought_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span>
     <span class="bp">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">1 if it is the first thought, 0 if it is the final thought.</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div> </div> </li> <li>[Optional] Create a prompt template using grammarflow‚Äôs PromptBuilder. Below is an example of the Llama prompt template. <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="n">llama_prompt</span> <span class="o">=</span> <span class="nc">PromptBuilder</span><span class="p">()</span>
<span class="n">llama_prompt</span><span class="p">.</span><span class="nf">add_section</span><span class="p">(</span>
 <span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">&lt;s&gt;[INST] &lt;&lt;SYS&gt;&gt;</span><span class="se">\n</span><span class="s">{system_context}</span><span class="se">\n</span><span class="s">&lt;&lt;/SYS&gt;&gt;</span><span class="sh">"</span><span class="p">,</span>
 <span class="n">placeholder</span><span class="o">=</span><span class="sh">"</span><span class="s">system_context</span><span class="sh">"</span><span class="p">,</span>
 <span class="n">define_grammar</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">llama_prompt</span><span class="p">.</span><span class="nf">add_section</span><span class="p">(</span>
 <span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">{user_message}[/INST]</span><span class="sh">"</span><span class="p">,</span>
 <span class="n">placeholder</span><span class="o">=</span><span class="sh">"</span><span class="s">user_message</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div> </div> <p>You can find an in-depth explanation on making prompts <a href="https://github.com/e-lab/SyntaxShaper/blob/main/samples/demo.ipynb" rel="external nofollow noopener" target="_blank">here</a>!</p> </li> <li>[Optional] If you decide to make your own template, define your system_context and user_message <code class="language-plaintext highlighter-rouge">placeholders</code>. <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="n">system_context</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">Your goal is to think and plan out how to solve questions using agent tools provided to you. Think about all aspects of your thought process.</span><span class="sh">"""</span>
<span class="n">user_message</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">Who is Vladmir Putin?</span><span class="sh">"""</span>
</code></pre></div> </div> </li> <li>Invoke the <code class="language-plaintext highlighter-rouge">Constrain</code> block with the prompt. Set the configuration metadata, and format the prompt with the required <code class="language-plaintext highlighter-rouge">grammars</code> and <code class="language-plaintext highlighter-rouge">placeholders</code>. <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nc">Constrain</span><span class="p">(</span><span class="n">llama_prompt</span><span class="p">)</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
 <span class="n">manager</span><span class="p">.</span><span class="nf">set_config</span><span class="p">(</span>
     <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">json</span><span class="sh">'</span><span class="p">,</span> <span class="c1"># or 'xml', 'toml'. 
</span>     <span class="n">return_sequence</span><span class="o">=</span><span class="sh">'</span><span class="s">single_response</span><span class="sh">'</span> <span class="c1"># or 'multi_response', if you need multiple grammars. 
</span> <span class="p">)</span>

 <span class="c1"># Makes the changes to the prompt
</span> <span class="n">manager</span><span class="p">.</span><span class="nf">format_prompt</span><span class="p">(</span><span class="n">placeholders</span><span class="o">=</span><span class="p">{</span> <span class="c1"># if you have placeholders in the prompt
</span>                       <span class="sh">'</span><span class="s">user_message</span><span class="sh">'</span><span class="p">:</span> <span class="n">user_message</span><span class="p">,</span>
                       <span class="sh">'</span><span class="s">system_context</span><span class="sh">'</span><span class="p">:</span> <span class="n">system_context</span>
                       <span class="p">},</span>
                       <span class="n">grammars</span><span class="o">=</span><span class="p">[{</span>
                           <span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">This format describes your current thinking state</span><span class="sh">'</span><span class="p">,</span> <span class="c1"># Description of the response format
</span>                           <span class="sh">'</span><span class="s">model</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="n">ThoughtState</span><span class="p">]}</span>
                       <span class="p">]</span>
 <span class="p">)</span>

 <span class="c1"># Assume `llm` to be a call to a model
</span> <span class="n">llm_response</span> <span class="o">=</span> <span class="n">llm</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">manager</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

 <span class="c1"># Parse the response into a custom dataclass for holding values
</span> <span class="n">response</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">llm_response</span><span class="p">)</span>
</code></pre></div> </div> </li> <li>Extract the required values from the response to perform necessary functions on.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">observation</span> <span class="o">=</span> <span class="nc">PerformSomeAction</span><span class="p">(</span>
  <span class="n">action</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">ThoughtState</span><span class="p">.</span><span class="n">action</span><span class="p">,</span> 
  <span class="n">action_input</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">ThoughtState</span><span class="p">.</span><span class="n">action_input</span>
<span class="p">)</span> 
</code></pre></div></div> <ol> <li>Continue to the next iteration in your agent chain!</li> </ol> <h3 id="examples--samples">Examples (@ samples/)</h3> <ol> <li>For a general overview of what GrammarFlow can do, look at <a href="https://github.com/e-lab/SyntaxShaper/blob/main/samples/demo.ipynb" rel="external nofollow noopener" target="_blank">demo.ipynb</a>.</li> <li>For my modification to <a href="https://github.com/ysymyth/ReAct" rel="external nofollow noopener" target="_blank">ReAct‚Äôs</a> evaluation code on <a href="https://hotpotqa.github.io/" rel="external nofollow noopener" target="_blank">HotPotQA</a>, look at <a href="https://github.com/e-lab/SyntaxShaper/blob/main/samples/hotpotqa/hotpotqa_modified.ipynb" rel="external nofollow noopener" target="_blank">hotpotqa_modified</a>.</li> <li>I‚Äôve also added an implementation of a <a href="https://github.com/e-lab/SyntaxShaper/blob/main/samples/bert_finetuning/annotator.ipynb" rel="external nofollow noopener" target="_blank">data annotator</a> for this <a href="https://www.datasciencecentral.com/how-to-fine-tune-bert-transformer-with-spacy-3/" rel="external nofollow noopener" target="_blank">BERT fine-tuning guide</a>.</li> </ol> <h3 id="gnbf-grammar">GNBF Grammar</h3> <p>GrammarFlow also has functionality to convert a pydantic model into GNBF grammar.</p> <blockquote> <p>‚ÄúGBNF (GGML BNF) is a format for defining formal grammars to constrain model outputs in llama.cpp. For example, you can use it to force the model to generate valid JSON, or speak only in emojis.‚Äù Read more about it here: https://github.com/ggerganov/llama.cpp/blob/master/grammars/README.md</p> </blockquote> <p>This can then be passed into llama.cpp using llama-cpp-python to ensure that sampling of logits can take place with rules in mind.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define your model 
</span><span class="k">class</span> <span class="nc">TeamMember</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">TaskUpdate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">update_time</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">bool</span>

<span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">assigned_to</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TeamMember</span><span class="p">]</span>
    <span class="n">due_date</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">updates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TaskUpdate</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Project</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">project_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">team_members</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TeamMember</span><span class="p">]</span>
    <span class="n">grammars</span><span class="p">:</span> <span class="n">Task</span>

<span class="c1"># Convert to grammar
</span><span class="kn">from</span> <span class="n">grammarflow</span> <span class="kn">import</span> <span class="n">GNBF</span>

<span class="n">grammar</span> <span class="o">=</span> <span class="nc">GNBF</span><span class="p">(</span><span class="n">Project</span><span class="p">).</span><span class="nf">generate_grammar</span><span class="p">()</span>

<span class="c1"># Verify with LlamaGrammar
</span><span class="n">GNBF</span><span class="p">.</span><span class="nf">verify_grammar</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>

<span class="c1"># Use it with the model 
</span><span class="k">with</span> <span class="nc">Constrain</span><span class="p">(</span><span class="n">llama_prompt</span><span class="p">)</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span> 
    <span class="n">manager</span><span class="p">.</span><span class="nf">set_config</span><span class="p">(...)</span>
    <span class="n">manager</span><span class="p">.</span><span class="nf">format_prompt</span><span class="p">(...)</span>

    <span class="n">llm_response</span> <span class="o">=</span> <span class="nf">llm</span><span class="p">(</span>
        <span class="n">manager</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span>
        <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">llm_response</span><span class="p">)</span>
</code></pre></div></div> <h2 id="remarks">Remarks!</h2> <p>Please keep in mind that this package is purely software driven and aims to make developers lives a little simpler. Powerful models like GPT, Llama and Mixtral Instruct work well with this package. MoE systems are able to evaluate which model can provide reasoning and constrainability (purely how well it handles ‚Äòinstructions‚Äô).</p> <p>However, with an increase in the complexity of the prompt, most models fail. This has to do with the model itself, and can be improved using token sampling using llama.cpp. But, a purely prompt-based approach cannot solve everything.</p> <p>Take, for example, you want to evaluate hotpotqa as explained in this notebook. When you run the scipt, you might find that Mixtral outputs parseable returns for JSON and XML formats in the first 2 runs. Post this, the model gets confused because of the way the prompt itself is constructed + ReAct‚Äôs helper functions formats.</p> <h2 id="citation">Citation</h2> <p>We appreciate it if you would please cite this repo if you found the library useful for your work:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@software{GrammarFlow,
  author = {Ravikiran, Akshath Raghav and Culurciello, Eugenio},
  title = {GrammarFlow: Powering Agent Chains by Constraining LLM Outputs},
  year = {2024},
  publisher = {GitHub},
  journal = {GitHub repository},
  howpublished = {\url{https://github.com/e-lab/GrammarFlow}}, 
  version = {0.0.9}
}
</code></pre></div></div> </body></html>